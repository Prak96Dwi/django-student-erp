<!-- chat/templates/chat/room.html -->
{% extends 'chat/base.html' %}
{% load static %}



{% block body-content %}
<div class="container txt-center">
    <div style="margin-left:150px; margin-top: 150px; margin-bottom: 80px;">
    {% for i in message %}
        <div style="background-color: lightblue">
            <b><small>{{ i.e_name }}</small></b>
            <p>{{ i.e_message }}</p>
        </div>
        <div>
            {% if i.e_image %}
                <embed  src="{{ i.e_image.url }}" height="100px" width="100px" />
                <a href="{{ i.e_image.url }}" download>download</a>
            {% endif %}
        </div>
        
    {% endfor %} 

    <div style="background-color: white">
        <b><p id="demo1"></p></b>
        <p  id="demo2"></p>
    </div>
    
    
    <!-- <textarea id="chat-log" cols="100" rows="20" class="form-control"></textarea><br> -->
    <form method="POST" enctype="multipart/form-data">
    {% csrf_token %}

        <div class="form-group row"
            style="position: fixed; bottom: 0;">
            <div class="col-md-8 col-bg-8 col-sm-8 col-lg-8">
                {{ form.mytext }}
            </div>

            <div class="col-md-2 col-bg-2 col-sm-2 col-lg-2">
                <div class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownMenuLink" 
                    data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                      <i class="fa fa-upload choseimage" aria-hidden="true"></i>
                    </a>
                    <div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
                        <a class="dropdown-item" href="#">Image {{ form.myimage }}</a>
                        <a class="dropdown-item" href="#">File {{ form.myimage }}</a>
                    </div>
                </div>
            </div>

            <div class="col-md-2 col-bg-2 col-sm-2 col-lg-2">
             <input id="chat-message-submit" type="submit" class="btn allbtn" style=""
                value="Send">
            </div>
        </div>
    </form>
    
    {{ room_name|json_script:"room-name" }}
    {{ user_name|json_script:"user-name" }}
    <script>
        const username = JSON.parse(document.getElementById('user-name').textContent);
        const roomName = JSON.parse(document.getElementById('room-name').textContent);

        const chatSocket = new WebSocket(
            'ws://'
            + window.location.host
            + '/ws/chat/'
            + roomName
            + '/'
        );
        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);

            var person = {
                fullName: function() {
                return this.userName;
                }
            }

            var message = {
                myMessage: function(){
                    return this.myMsg
                }
            }

            var data1 = {
                userName:    data.username,
            }

            var data2 = {
                myMsg :      data.message,
            }

            var x = person.fullName.call(data1); 
            var y = message.myMessage.call(data2)
            document.getElementById("demo1").innerHTML = x;
            document.getElementById("demo2").innerHTML = y;
        };


        chatSocket.onclose = function(e) {
            console.error('Chat socket closed unexpectedly');
        };

        
        

        document.querySelector('#chat-message-submit').onclick = function(e) {
            const messageInputDom = document.querySelector('#chat-message-input');
            const message = messageInputDom.value
       
       
            chatSocket.send(JSON.stringify({
                'message': message,
                'username': username,
            }));
            // messageInputDom.value = '';
        };


        function ChoseImage(){
            document.getElementById("SelectImage").click()
        }

        
    </script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script type="text/javascript">
        $(document).ready(function(){
          $(".choseimage").click(function(){
            
          });
        });
    </script>
</div>

{% endblock body-content %}

{% block javascript-code %}
    

{% endblock javascript-code %}